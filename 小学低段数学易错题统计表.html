<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦ä½æ®µæ•°å­¦æ˜“é”™é¢˜ç»Ÿè®¡è¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            contain: layout style paint;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 15px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 20px;
            border-left: 5px solid #667eea;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .info-box ul {
            margin-left: 25px;
            color: #555;
            line-height: 2;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.2s ease-out;
            contain: layout style;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
            contain: layout style;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            contain: layout;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
            font-size: 16px;
            contain: layout style;
        }
        
        td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
            contain: layout style;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s;
        }
        
        input[type="text"], 
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        textarea {
            min-height: 50px;
            resize: vertical;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        
        .btn-group {
            margin: 20px 0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:active {
            transform: translateY(0);
            transition: transform 0.1s;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .stats-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .tabs, .btn-group, .info-box {
                display: none;
            }
            .tab-content {
                display: block !important;
            }
            .container {
                box-shadow: none;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 24px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å°å­¦ä½æ®µæ•°å­¦æ˜“é”™é¢˜ç»Ÿè®¡è¡¨</h1>
        <div class="subtitle">ä»çº é”™åˆ°æ‚Ÿé”™ï¼šå°å­¦ä½æ®µæ•°å­¦é”™è¯¯èµ„æºåŒ–æ•™å­¦ç­–ç•¥çš„æ·±åº¦ç ”ç©¶</div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ“‹ æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“Š é”™è¯¯ç±»å‹ç»Ÿè®¡</button>
            <button class="tab" onclick="switchTab(2)">ğŸ“– çŸ¥è¯†ç‚¹ç»Ÿè®¡</button>
            <button class="tab" onclick="switchTab(3)">ğŸ‘¤ å­¦ç”Ÿé”™è¯¯æ¡£æ¡ˆ</button>
            <button class="tab" onclick="switchTab(4)">ğŸ“ˆ çº é”™æ•ˆæœè·Ÿè¸ª</button>
            <button class="tab" onclick="switchTab(5)">ğŸ“ ç±»ä¼¼é¢˜ç›®ç”Ÿæˆ</button>
        </div>
        
        <!-- å·¥ä½œè¡¨1: æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨ -->
        <div class="tab-content active" id="tab0">
            <div class="btn-group">
                <button onclick="addRow(0)">â• æ·»åŠ è¡Œ</button>
                <button onclick="deleteLastRow(0)" class="btn-secondary">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
                <button onclick="exportToExcel()" class="btn-success">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button onclick="saveData()" class="btn-info">ğŸ’¾ ä¿å­˜æ•°æ®</button>
                <button onclick="autoGenerateStats()" class="btn-info">ğŸ“Š è‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡</button>
                <button onclick="clearData(0)" class="btn-secondary">ğŸ”„ æ¸…ç©ºæ•°æ®</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="table0">
                    <thead>
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">å­¦ç”Ÿå§“å</th>
                            <th style="width: 100px;">ç­çº§</th>
                            <th style="width: 130px;">çŸ¥è¯†ç‚¹ç±»åˆ«</th>
                            <th style="width: 200px;">å…·ä½“é¢˜ç›®/é¢˜å‹æè¿°</th>
                            <th style="width: 120px;">é”™è¯¯ç±»å‹</th>
                            <th style="width: 90px;">ç­çº§å‡ºé”™äººæ•°</th>
                            <th style="width: 200px;">é”™è¯¯åŸå› åˆ†æ</th>
                            <th style="width: 200px;">çº é”™æªæ–½</th>
                            <th style="width: 130px;">çº é”™åæŒæ¡æƒ…å†µ</th>
                            <th style="width: 150px;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="tbody0">
                        <!-- ç¤ºä¾‹æ•°æ®å°†ç”±JSç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å·¥ä½œè¡¨2: é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡ -->
        <div class="tab-content" id="tab1">
            <div class="btn-group">
                <button onclick="addRow(1)">â• æ·»åŠ è¡Œ</button>
                <button onclick="deleteLastRow(1)" class="btn-secondary">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
                <button onclick="calculateStats()" class="btn-info">ğŸ“Š è‡ªåŠ¨ç»Ÿè®¡</button>
                <button onclick="clearData(1)" class="btn-secondary">ğŸ”„ æ¸…ç©ºæ•°æ®</button>
            </div>
            <table id="table1">
                <thead>
                    <tr>
                        <th style="width: 200px;">é”™è¯¯ç±»å‹</th>
                        <th style="width: 120px;">å‡ºç°æ¬¡æ•°</th>
                        <th style="width: 120px;">å æ¯”(%)</th>
                        <th>å…¸å‹é”™è¯¯æè¿°</th>
                    </tr>
                </thead>
                <tbody id="tbody1">
                    <!-- æ•°æ®å°†ç”±JSç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <!-- å·¥ä½œè¡¨3: çŸ¥è¯†ç‚¹æ˜“é”™ç»Ÿè®¡ -->
        <div class="tab-content" id="tab2">
            <div class="btn-group">
                <button onclick="addRow(2)">â• æ·»åŠ è¡Œ</button>
                <button onclick="deleteLastRow(2)" class="btn-secondary">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
                <button onclick="clearData(2)" class="btn-secondary">ğŸ”„ æ¸…ç©ºæ•°æ®</button>
            </div>
            <table id="table2">
                <thead>
                    <tr>
                        <th style="width: 200px;">çŸ¥è¯†ç‚¹</th>
                        <th style="width: 120px;">é”™è¯¯äººæ•°</th>
                        <th style="width: 120px;">é”™è¯¯ç‡(%)</th>
                        <th style="width: 300px;">ä¸»è¦é”™è¯¯è¡¨ç°</th>
                        <th>æ•™å­¦æ”¹è¿›å»ºè®®</th>
                    </tr>
                </thead>
                <tbody id="tbody2">
                    <!-- æ•°æ®å°†ç”±JSç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <!-- å·¥ä½œè¡¨4: å­¦ç”Ÿä¸ªäººé”™è¯¯æ¡£æ¡ˆ -->
        <div class="tab-content" id="tab3">
            <div class="btn-group">
                <select id="classFilter" onchange="filterByClass()">
                    <option value="">æ‰€æœ‰ç­çº§</option>
                    <option value="äºŒ(1)ç­">äºŒ(1)ç­</option>
                    <option value="äºŒ(2)ç­">äºŒ(2)ç­</option>
                    <option value="äºŒ(3)ç­">äºŒ(3)ç­</option>
                    <option value="äºŒ(4)ç­">äºŒ(4)ç­</option>
                    <option value="äºŒ(5)ç­">äºŒ(5)ç­</option>
                    <option value="äºŒ(6)ç­">äºŒ(6)ç­</option>
                </select>
                <input type="text" id="studentFilter" placeholder="å­¦ç”Ÿå§“å" oninput="filterByStudent()">
                <button onclick="addRow(3)">â• æ·»åŠ è¡Œ</button>
                <button onclick="deleteLastRow(3)" class="btn-secondary">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
                <button onclick="clearData(3)" class="btn-secondary">ğŸ”„ æ¸…ç©ºæ•°æ®</button>
            </div>
            <table id="table3">
                <thead>
                    <tr>
                        <th style="width: 120px;">å­¦ç”Ÿå§“å</th>
                        <th style="width: 100px;">ç­çº§</th>
                        <th style="width: 250px;">è–„å¼±çŸ¥è¯†ç‚¹</th>
                        <th style="width: 150px;">æ˜“é”™ç±»å‹</th>
                        <th style="width: 250px;">çº é”™ç­–ç•¥</th>
                        <th style="width: 200px;">è·Ÿè¸ªæ•ˆæœ</th>
                    </tr>
                </thead>
                <tbody id="tbody3">
                    <!-- æ•°æ®å°†ç”±JSç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <!-- å·¥ä½œè¡¨5: çº é”™æ•ˆæœè·Ÿè¸ªè¡¨ -->
        <div class="tab-content" id="tab4">
            <div class="btn-group">
                <button onclick="addRow(4)">â• æ·»åŠ è¡Œ</button>
                <button onclick="deleteLastRow(4)" class="btn-secondary">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
                <button onclick="clearData(4)" class="btn-secondary">ğŸ”„ æ¸…ç©ºæ•°æ®</button>
            </div>
            <table id="table4">
                <thead>
                    <tr>
                        <th style="width: 120px;">å­¦ç”Ÿå§“å</th>
                        <th style="width: 200px;">é”™è¯¯çŸ¥è¯†ç‚¹</th>
                        <th style="width: 130px;">åˆæ¬¡å‡ºé”™æ—¥æœŸ</th>
                        <th style="width: 130px;">çº é”™æ—¥æœŸ</th>
                        <th style="width: 250px;">çº é”™æªæ–½</th>
                        <th style="width: 150px;">çº é”™æ•ˆæœ</th>
                        <th style="width: 200px;">å¤‡æ³¨</th>
                    </tr>
                </thead>
                <tbody id="tbody4">
                    <!-- æ•°æ®å°†ç”±JSç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <!-- å·¥ä½œè¡¨6: ç±»ä¼¼é¢˜ç›®ç”Ÿæˆ -->
        <div class="tab-content" id="tab5">
            <div class="btn-group">
                <button onclick="generateSimilarQuestions()" class="btn-success">ğŸ”„ ç”Ÿæˆç±»ä¼¼é¢˜ç›®</button>
                <button onclick="clearGeneratedQuestions()" class="btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºç”Ÿæˆé¢˜ç›®</button>
            </div>
            <div id="questionGenerator" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">é€‰æ‹©æ˜“é”™é¢˜ç”Ÿæˆç±»ä¼¼é¢˜ç›®</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                    <select id="errorTopicSelect" style="flex: 1; min-width: 200px;">
                        <option value="">è¯·é€‰æ‹©çŸ¥è¯†ç‚¹</option>
                    </select>
                    <select id="errorTypeSelect" style="flex: 1; min-width: 200px;">
                        <option value="">è¯·é€‰æ‹©é”™è¯¯ç±»å‹</option>
                    </select>
                    <button onclick="loadErrorQuestions()" style="padding: 10px 20px;">ğŸ” æŸ¥æ‰¾ç›¸å…³é”™é¢˜</button>
                </div>
                <div id="errorQuestionsList" style="margin-top: 20px;"></div>
            </div>
            <div id="generatedQuestions" style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">ç”Ÿæˆçš„ç±»ä¼¼é¢˜ç›®</h3>
                <div id="generatedQuestionsList"></div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®æ¨¡æ¿
        const templates = {
            0: [ // æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨
                ['', '', '', '', '', '', '', '', '', '', '']
            ],
            1: [ // é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡
                ['', '', '', '']
            ],
            2: [ // çŸ¥è¯†ç‚¹æ˜“é”™ç»Ÿè®¡
                ['', '', '', '', '']
            ],
            3: [ // å­¦ç”Ÿä¸ªäººé”™è¯¯æ¡£æ¡ˆ
                ['', '', '', '', '', '']
            ],
            4: [ // çº é”™æ•ˆæœè·Ÿè¸ªè¡¨
                ['', '', '', '', '', '', '']
            ]
        };

        // ä¸‹æ‹‰é€‰é¡¹æ•°æ®
        const dropdownOptions = {
            classes: ['äºŒ(1)ç­', 'äºŒ(2)ç­', 'äºŒ(3)ç­', 'äºŒ(4)ç­', 'äºŒ(5)ç­', 'äºŒ(6)ç­'],
            knowledgePoints: [
                '100ä»¥å†…åŠ å‡æ³•', 'è¡¨å†…ä¹˜æ³•', 'è¡¨å†…é™¤æ³•', 'ä¸‡ä»¥å†…æ•°çš„è®¤è¯†', 
                'æœ‰ä½™æ•°çš„é™¤æ³•', 'æ—¶åˆ†ç§’', 'é•¿åº¦å•ä½', 'é‡é‡å•ä½', 'è®¤è¯†å›¾å½¢', 
                'å›¾å½¢çš„è¿åŠ¨', 'æ•°æ®æ”¶é›†æ•´ç†', 'æ•°å­¦å¹¿è§’-æ¨ç†'
            ],
            errorTypes: [
                'è®¡ç®—é”™è¯¯', 'æ¦‚å¿µæ··æ·†', 'å®¡é¢˜ä¸æ¸…', 'è®°å¿†æ€§é”™è¯¯', 
                'ç²—å¿ƒå¤§æ„', 'é€»è¾‘æ¨ç†é”™è¯¯', 'æ•°ä½æ··æ·†', 'è¿ç®—é¡ºåºé”™è¯¯', 
                'å•ä½æ¢ç®—é”™è¯¯', 'å›¾å½¢è¯†åˆ«é”™è¯¯', 'åº”ç”¨é¢˜ç†è§£é”™è¯¯', 'è§£é¢˜æ–¹æ³•é”™è¯¯'
            ],
            correctionMeasures: [
                'å¼ºåŒ–åŸºç¡€ç»ƒä¹ ', 'ä¸€å¯¹ä¸€è¾…å¯¼', 'å°ç»„åˆä½œå­¦ä¹ ', 'ä½¿ç”¨æ•™å…·æ¼”ç¤º', 
                'è¶£å‘³è®°å¿†æ³•', 'é”™é¢˜æœ¬æ•´ç†', 'å˜å¼ç»ƒä¹ ', 'å®¶é•¿é…åˆç›‘ç£', 
                'æ€ç»´å¯¼å›¾æ¢³ç†', 'æ¯æ—¥ä¸€ç»ƒ', 'åŒä¼´äº’åŠ©', 'æ•™å¸ˆä¸ªåˆ«æŒ‡å¯¼'
            ],
            masteryLevels: ['å®Œå…¨æŒæ¡', 'åŸºæœ¬æŒæ¡', 'æ­£åœ¨æŒæ¡', 'æŒæ¡å›°éš¾', 'æœªæŒæ¡'],
            remarks: ['éœ€æŒç»­å…³æ³¨', 'é‡ç‚¹å…³æ³¨å¯¹è±¡', 'è¿›æ­¥æ˜æ˜¾', 'é€€æ­¥éœ€æ³¨æ„', 'ç¨³å®šå‘å±•', 'éœ€è¦åŠ å¼º']
        };

        // ç­›é€‰æ¡ä»¶
        let filterConditions = {
            class: '',
            student: ''
        };

        // ç¤ºä¾‹æ•°æ®ï¼ˆå·²ç§»é™¤ï¼‰
        const sampleData = {};

        // åˆå§‹åŒ–æ•°æ®
        function initTable(tableIndex) {
            const tbody = document.getElementById(`tbody${tableIndex}`);
            tbody.innerHTML = '';
            
            // åªæ·»åŠ ç©ºè¡Œï¼Œä¸ä½¿ç”¨ç¤ºä¾‹æ•°æ®
            for (let i = 0; i < 10; i++) {
                addRow(tableIndex, i + 1);
            }
            
            loadData();
        }

        // åˆ›å»ºä¸‹æ‹‰é€‰æ‹©æ¡†
        function createSelect(options, selectedValue, onChange) {
            const select = document.createElement('select');
            select.onchange = onChange;
            
            // æ·»åŠ ç©ºé€‰é¡¹
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'è¯·é€‰æ‹©';
            select.appendChild(emptyOption);
            
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                if (option === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
            
            return select;
        }

        // åˆ›å»ºæ–‡ä»¶ä¸Šä¼ æŒ‰é’®
        function createFileUpload(onChange) {
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.alignItems = 'center';
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                onChange(e);
                // æ˜¾ç¤ºé¢„è§ˆ
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        preview.src = event.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.style.display = 'none';
            
            const button = document.createElement('button');
            button.textContent = 'ğŸ“· æ‹ç…§ä¸Šä¼ ';
            button.type = 'button';
            button.onclick = () => input.click();
            button.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                font-size: 14px;
                cursor: pointer;
            `;
            
            const preview = document.createElement('img');
            preview.style.maxWidth = '100px';
            preview.style.maxHeight = '100px';
            preview.style.marginTop = '5px';
            preview.style.display = 'none';
            
            container.appendChild(input);
            container.appendChild(button);
            container.appendChild(preview);
            
            return container;
        }

        // æ·»åŠ è¡Œï¼ˆå¸¦æ•°æ®ï¼‰
        function addRowWithData(tableIndex, data, rowNum) {
            const tbody = document.getElementById(`tbody${tableIndex}`);
            const tr = document.createElement('tr');
            
            // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹æ“ä½œ
            let saveTimeout;
            const debouncedSave = () => {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveData();
                    saveTimeout = null;
                }, 300);
            };
            
            if (tableIndex === 0) {
                // ç­çº§ä¸‹æ‹‰é€‰æ‹©
                const classSelect = createSelect(dropdownOptions.classes, data[2] || '', debouncedSave);
                
                // çŸ¥è¯†ç‚¹ç±»åˆ«ä¸‹æ‹‰é€‰æ‹©
                const knowledgeSelect = createSelect(dropdownOptions.knowledgePoints, data[3] || '', debouncedSave);
                
                // é”™è¯¯ç±»å‹ä¸‹æ‹‰é€‰æ‹©
                const errorTypeSelect = createSelect(dropdownOptions.errorTypes, data[5] || '', debouncedSave);
                
                // çº é”™æªæ–½ä¸‹æ‹‰é€‰æ‹©ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
                const correctionSelect = createSelect(dropdownOptions.correctionMeasures, data[8] || '', debouncedSave);
                
                // æŒæ¡æƒ…å†µé€‰æ‹©
                const masterySelect = createSelect(dropdownOptions.masteryLevels, data[9] || '', debouncedSave);
                
                // å¤‡æ³¨é€‰æ‹©
                const remarkSelect = createSelect(dropdownOptions.remarks, data[10] || '', debouncedSave);
                
                // æ‹ç…§ä¸Šä¼ 
                const uploadContainer = createFileUpload(debouncedSave);
                
                tr.innerHTML = `
                    <td>${rowNum}</td>
                    <td><input type="text" value="${data[1] || ''}" oninput="debouncedSave()"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" value="${data[6] || '0'}" min="0" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[7] || ''}</textarea></td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                
                // æ’å…¥ä¸‹æ‹‰é€‰æ‹©æ¡†å’Œä¸Šä¼ æ§ä»¶
                const tds = tr.querySelectorAll('td');
                tds[2].appendChild(classSelect);
                tds[3].appendChild(knowledgeSelect);
                
                // åˆ›å»ºåŒ…å«æ–‡æœ¬è¾“å…¥å’Œä¸Šä¼ æ§ä»¶çš„å®¹å™¨
                const questionContainer = document.createElement('div');
                questionContainer.style.display = 'flex';
                questionContainer.style.flexDirection = 'column';
                questionContainer.style.alignItems = 'center';
                questionContainer.style.gap = '5px';
                
                const textInput = document.createElement('textarea');
                textInput.value = data[4] || '';
                textInput.oninput = debouncedSave;
                textInput.style.width = '100%';
                textInput.style.minHeight = '60px';
                textInput.placeholder = 'è¯·è¾“å…¥é¢˜ç›®æè¿°æˆ–ä¸Šä¼ å›¾ç‰‡';
                
                questionContainer.appendChild(textInput);
                questionContainer.appendChild(uploadContainer);
                tds[4].appendChild(questionContainer);
                
                tds[5].appendChild(errorTypeSelect);
                tds[8].appendChild(correctionSelect);
                tds[9].appendChild(masterySelect);
                tds[10].appendChild(remarkSelect);
            } else if (tableIndex === 1) {
                tr.innerHTML = `
                    <td><input type="text" value="${data[0] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="number" value="${data[1] || '0'}" min="0" oninput="debouncedSave()"></td>
                    <td><input type="number" value="${data[2] || '0'}" min="0" max="100" step="0.1" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[3] || ''}</textarea></td>
                `;
            } else if (tableIndex === 2) {
                tr.innerHTML = `
                    <td><input type="text" value="${data[0] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="number" value="${data[1] || '0'}" min="0" oninput="debouncedSave()"></td>
                    <td><input type="number" value="${data[2] || '0'}" min="0" max="100" step="0.1" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[3] || ''}</textarea></td>
                    <td><textarea oninput="debouncedSave()">${data[4] || ''}</textarea></td>
                `;
            } else if (tableIndex === 3) {
                tr.innerHTML = `
                    <td><input type="text" value="${data[0] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="text" value="${data[1] || ''}" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[2] || ''}</textarea></td>
                    <td><input type="text" value="${data[3] || ''}" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[4] || ''}</textarea></td>
                    <td><textarea oninput="debouncedSave()">${data[5] || ''}</textarea></td>
                `;
            } else if (tableIndex === 4) {
                tr.innerHTML = `
                    <td><input type="text" value="${data[0] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="text" value="${data[1] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="date" value="${data[2] || ''}" oninput="debouncedSave()"></td>
                    <td><input type="date" value="${data[3] || ''}" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[4] || ''}</textarea></td>
                    <td><input type="text" value="${data[5] || ''}" oninput="debouncedSave()"></td>
                    <td><textarea oninput="debouncedSave()">${data[6] || ''}</textarea></td>
                `;
            }
            
            tbody.appendChild(tr);
        }

        // ä¼˜åŒ–æ·»åŠ è¡Œå‡½æ•°ï¼Œå‡å°‘DOMæ“ä½œ
        function addRow(tableIndex) {
            const tbody = document.getElementById(`tbody${tableIndex}`);
            const rowCount = tbody.rows.length;
            const newRowData = [...templates[tableIndex][0]];
            addRowWithData(tableIndex, newRowData, rowCount + 1);
            
            // é˜²æŠ–ä¿å­˜
            if (window.addRowTimeout) clearTimeout(window.addRowTimeout);
            window.addRowTimeout = setTimeout(() => {
                saveData();
                window.addRowTimeout = null;
            }, 500);
        }

        // ä¼˜åŒ–åˆ é™¤è¡Œå‡½æ•°
        function deleteLastRow(tableIndex) {
            const tbody = document.getElementById(`tbody${tableIndex}`);
            if (tbody.rows.length > 1) {
                tbody.deleteRow(-1);
                
                // é˜²æŠ–ä¿å­˜
                if (window.deleteRowTimeout) clearTimeout(window.deleteRowTimeout);
                window.deleteRowTimeout = setTimeout(() => {
                    saveData();
                    window.deleteRowTimeout = null;
                }, 500);
            } else {
                showMessage('è‡³å°‘ä¿ç•™ä¸€è¡Œæ•°æ®ï¼');
            }
        }

        // ä¼˜åŒ–åˆ‡æ¢æ ‡ç­¾é¡µå‡½æ•°
        function switchTab(index) {
            // é˜²æ­¢é¢‘ç¹åˆ‡æ¢
            if (window.switchingTab) return;
            window.switchingTab = true;
            
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
            
            // å»¶è¿Ÿé‡ç½®é˜²æ­¢é¢‘ç¹åˆ‡æ¢
            setTimeout(() => {
                window.switchingTab = false;
            }, 100);
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        let saveTimeout;
        function saveData() {
            // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹ä¿å­˜
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const allData = {};
                for (let i = 0; i < 5; i++) {
                    allData[i] = getTableData(i);
                }
                localStorage.setItem('mathErrorData', JSON.stringify(allData));
                showMessage('æ•°æ®å·²ä¿å­˜ï¼');
                saveTimeout = null;
            }, 500);
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            const saved = localStorage.getItem('mathErrorData');
            if (saved) {
                const allData = JSON.parse(saved);
                for (let i = 0; i < 5; i++) {
                    if (allData[i] && allData[i].length > 0) {
                        const tbody = document.getElementById(`tbody${i}`);
                        tbody.innerHTML = '';
                        allData[i].forEach((row, index) => {
                            addRowWithData(i, row, index + 1);
                        });
                    }
                }
                // é‡æ–°åº”ç”¨ç­›é€‰
                applyFilter();
            }
        }

        // è·å–è¡¨æ ¼æ•°æ®
        function getTableData(tableIndex) {
            const tbody = document.getElementById(`tbody${tableIndex}`);
            const rows = tbody.querySelectorAll('tr');
            const data = [];
            
            rows.forEach((row, index) => {
                const rowData = [];
                if (tableIndex === 0) {
                    rowData.push(index + 1);
                    
                    // å¤„ç†ç¬¬ä¸€è¡Œè¡¨æ ¼çš„ç‰¹æ®Šç»“æ„
                    const cells = row.querySelectorAll('td');
                    
                    // å­¦ç”Ÿå§“å
                    const nameInput = cells[1].querySelector('input');
                    rowData.push(nameInput ? nameInput.value : '');
                    
                    // ç­çº§
                    const classSelect = cells[2].querySelector('select');
                    rowData.push(classSelect ? classSelect.value : '');
                    
                    // çŸ¥è¯†ç‚¹ç±»åˆ«
                    const knowledgeSelect = cells[3].querySelector('select');
                    rowData.push(knowledgeSelect ? knowledgeSelect.value : '');
                    
                    // å…·ä½“é¢˜ç›®/é¢˜å‹æè¿°ï¼ˆæ–‡æœ¬è¾“å…¥éƒ¨åˆ†ï¼‰
                    const questionContainer = cells[4].querySelector('div');
                    const textInput = questionContainer ? questionContainer.querySelector('textarea') : null;
                    rowData.push(textInput ? textInput.value : '');
                    
                    // é”™è¯¯ç±»å‹
                    const errorTypeSelect = cells[5].querySelector('select');
                    rowData.push(errorTypeSelect ? errorTypeSelect.value : '');
                    
                    // ç­çº§å‡ºé”™äººæ•°
                    const countInput = cells[6].querySelector('input');
                    rowData.push(countInput ? countInput.value : '');
                    
                    // é”™è¯¯åŸå› åˆ†æ
                    const reasonTextarea = cells[7].querySelector('textarea');
                    rowData.push(reasonTextarea ? reasonTextarea.value : '');
                    
                    // çº é”™æªæ–½
                    const correctionSelect = cells[8].querySelector('select');
                    rowData.push(correctionSelect ? correctionSelect.value : '');
                    
                    // çº é”™åæŒæ¡æƒ…å†µ
                    const masterySelect = cells[9].querySelector('select');
                    rowData.push(masterySelect ? masterySelect.value : '');
                    
                    // å¤‡æ³¨
                    const remarkSelect = cells[10].querySelector('select');
                    rowData.push(remarkSelect ? remarkSelect.value : '');
                } else {
                    const inputs = row.querySelectorAll('input, textarea');
                    inputs.forEach(input => {
                        rowData.push(input.value);
                    });
                }
                data.push(rowData);
            });
            
            return data;
        }

        // å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            const sheetNames = ['æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨', 'é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡', 'çŸ¥è¯†ç‚¹æ˜“é”™ç»Ÿè®¡', 'å­¦ç”Ÿä¸ªäººé”™è¯¯æ¡£æ¡ˆ', 'çº é”™æ•ˆæœè·Ÿè¸ªè¡¨'];
            
            for (let i = 0; i < 5; i++) {
                const table = document.getElementById(`table${i}`);
                const ws = XLSX.utils.table_to_sheet(table);
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [];
                const firstRow = table.querySelector('thead tr');
                firstRow.querySelectorAll('th').forEach(th => {
                    colWidths.push({wch: 15});
                });
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, sheetNames[i]);
            }
            
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            XLSX.writeFile(wb, `å°å­¦ä½æ®µæ•°å­¦æ˜“é”™é¢˜ç»Ÿè®¡è¡¨_${date}.xlsx`);
            showMessage('Excelæ–‡ä»¶å·²å¯¼å‡ºï¼');
        }

        // æ¸…ç©ºæ•°æ®
        function clearData(tableIndex) {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è¡¨æ ¼çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                const tbody = document.getElementById(`tbody${tableIndex}`);
                tbody.innerHTML = '';
                templates[tableIndex].forEach((row, index) => {
                    addRowWithData(tableIndex, row, index + 1);
                });
                saveData();
                showMessage('æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // ä¼˜åŒ–è‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡åŠŸèƒ½
        function autoGenerateStats() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (window.generatingStats) {
                showMessage('æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            window.generatingStats = true;
            
            // å»¶è¿Ÿæ‰§è¡Œä»¥é¿å…é˜»å¡UI
            setTimeout(() => {
                try {
                    // è·å–æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨çš„æ•°æ®
                    const mainTableData = getTableData(0);
                    
                    if (mainTableData.length === 0 || (mainTableData.length === 1 && mainTableData[0].every(cell => cell === ''))) {
                        showMessage('æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨æš‚æ— æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯');
                        window.generatingStats = false;
                        return;
                    }
                    
                    // ç”Ÿæˆé”™è¯¯ç±»å‹ç»Ÿè®¡è¡¨æ•°æ®
                    generateErrorTypeStats(mainTableData);
                    
                    // ç”ŸæˆçŸ¥è¯†ç‚¹ç»Ÿè®¡è¡¨æ•°æ®
                    generateKnowledgePointStats(mainTableData);
                    
                    // ç”Ÿæˆå­¦ç”Ÿé”™è¯¯æ¡£æ¡ˆæ•°æ®
                    generateStudentErrorArchive(mainTableData);
                    
                    saveData();
                    showMessage('ç»Ÿè®¡è¡¨æ ¼æ•°æ®å·²è‡ªåŠ¨ç”Ÿæˆï¼');
                } catch (error) {
                    showMessage('ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                    console.error(error);
                } finally {
                    window.generatingStats = false;
                }
            }, 50);
        }
        
        // ç”Ÿæˆé”™è¯¯ç±»å‹ç»Ÿè®¡è¡¨æ•°æ®
        function generateErrorTypeStats(mainTableData) {
            // ç»Ÿè®¡å„ç§é”™è¯¯ç±»å‹å‡ºç°æ¬¡æ•°
            const errorTypeCount = {};
            let totalErrors = 0;
            
            mainTableData.forEach(row => {
                if (row.length > 5) {
                    const errorType = row[5]; // é”™è¯¯ç±»å‹
                    const errorCount = parseInt(row[6]) || 0; // ç­çº§å‡ºé”™äººæ•°
                    
                    if (errorType && errorType.trim() !== '') {
                        errorTypeCount[errorType] = (errorTypeCount[errorType] || 0) + errorCount;
                        totalErrors += errorCount;
                    }
                }
            });
            
            // æ›´æ–°é”™è¯¯ç±»å‹ç»Ÿè®¡è¡¨
            const errorTypeTbody = document.getElementById('tbody1');
            errorTypeTbody.innerHTML = '';
            
            // æ·»åŠ ç»Ÿè®¡ç»“æœ
            for (const [errorType, count] of Object.entries(errorTypeCount)) {
                const percentage = totalErrors > 0 ? ((count / totalErrors) * 100).toFixed(1) : '0.0';
                const newRow = ['', '', '', ''];
                newRow[0] = errorType;
                newRow[1] = count.toString();
                newRow[2] = percentage;
                addRowWithData(1, newRow, errorTypeTbody.rows.length + 1);
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ç©ºè¡Œ
            if (Object.keys(errorTypeCount).length === 0) {
                for (let i = 0; i < 5; i++) {
                    addRow(1, i + 1);
                }
            }
        }
        
        // ç”ŸæˆçŸ¥è¯†ç‚¹ç»Ÿè®¡è¡¨æ•°æ®
        function generateKnowledgePointStats(mainTableData) {
            // ç»Ÿè®¡å„ä¸ªçŸ¥è¯†ç‚¹çš„é”™è¯¯æƒ…å†µ
            const knowledgePointStats = {};
            
            mainTableData.forEach(row => {
                if (row.length > 3) {
                    const knowledgePoint = row[3]; // çŸ¥è¯†ç‚¹ç±»åˆ«
                    const errorCount = parseInt(row[6]) || 0; // ç­çº§å‡ºé”™äººæ•°
                    
                    if (knowledgePoint && knowledgePoint.trim() !== '') {
                        if (!knowledgePointStats[knowledgePoint]) {
                            knowledgePointStats[knowledgePoint] = {
                                errorStudents: 0,
                                errorDetails: new Set(),
                                suggestions: []
                            };
                        }
                        knowledgePointStats[knowledgePoint].errorStudents += errorCount;
                        knowledgePointStats[knowledgePoint].errorDetails.add(`${row[1] || 'æœªçŸ¥å­¦ç”Ÿ'}(${row[5] || 'æœªçŸ¥é”™è¯¯ç±»å‹'})`);
                    }
                }
            });
            
            // æ›´æ–°çŸ¥è¯†ç‚¹ç»Ÿè®¡è¡¨
            const knowledgePointTbody = document.getElementById('tbody2');
            knowledgePointTbody.innerHTML = '';
            
            // æ·»åŠ ç»Ÿè®¡ç»“æœ
            for (const [knowledgePoint, stats] of Object.entries(knowledgePointStats)) {
                const newRow = ['', '', '', '', ''];
                newRow[0] = knowledgePoint;
                newRow[1] = stats.errorStudents.toString();
                newRow[2] = '0.0'; // é”™è¯¯ç‡éœ€è¦æ ¹æ®ç­çº§æ€»äººæ•°è®¡ç®—ï¼Œè¿™é‡Œæš‚æ—¶è®¾ä¸º0.0
                newRow[3] = Array.from(stats.errorDetails).join('ï¼›');
                newRow[4] = `åŠ å¼º${knowledgePoint}ç›¸å…³ç»ƒä¹ `;
                addRowWithData(2, newRow, knowledgePointTbody.rows.length + 1);
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ç©ºè¡Œ
            if (Object.keys(knowledgePointStats).length === 0) {
                for (let i = 0; i < 5; i++) {
                    addRow(2, i + 1);
                }
            }
        }
        
        // ç”Ÿæˆå­¦ç”Ÿé”™è¯¯æ¡£æ¡ˆæ•°æ®
        function generateStudentErrorArchive(mainTableData) {
            // æŒ‰å­¦ç”Ÿç»Ÿè®¡é”™è¯¯æƒ…å†µ
            const studentErrors = {};
            
            mainTableData.forEach(row => {
                if (row.length > 3) {
                    const studentName = row[1]; // å­¦ç”Ÿå§“å
                    const className = row[2]; // ç­çº§
                    const knowledgePoint = row[3]; // çŸ¥è¯†ç‚¹ç±»åˆ«
                    const errorType = row[5]; // é”™è¯¯ç±»å‹
                    
                    if (studentName && studentName.trim() !== '') {
                        if (!studentErrors[studentName]) {
                            studentErrors[studentName] = {
                                className: className || '',
                                weakPoints: new Set(),
                                errorTypes: new Set(),
                                strategies: [],
                                tracking: ''
                            };
                        }
                        
                        if (knowledgePoint && knowledgePoint.trim() !== '') {
                            studentErrors[studentName].weakPoints.add(knowledgePoint);
                        }
                        
                        if (errorType && errorType.trim() !== '') {
                            studentErrors[studentName].errorTypes.add(errorType);
                        }
                    }
                }
            });
            
            // æ›´æ–°å­¦ç”Ÿé”™è¯¯æ¡£æ¡ˆè¡¨
            const studentArchiveTbody = document.getElementById('tbody3');
            studentArchiveTbody.innerHTML = '';
            
            // æ·»åŠ ç»Ÿè®¡ç»“æœ
            for (const [studentName, stats] of Object.entries(studentErrors)) {
                const newRow = ['', '', '', '', '', ''];
                newRow[0] = studentName;
                newRow[1] = stats.className;
                newRow[2] = Array.from(stats.weakPoints).join('ï¼›');
                newRow[3] = Array.from(stats.errorTypes).join('ï¼›');
                newRow[4] = `é’ˆå¯¹${Array.from(stats.weakPoints).join('ã€')}è¿›è¡Œä¸“é¡¹ç»ƒä¹ `;
                newRow[5] = 'è·Ÿè¸ªä¸­';
                addRowWithData(3, newRow, studentArchiveTbody.rows.length + 1);
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ç©ºè¡Œ
            if (Object.keys(studentErrors).length === 0) {
                for (let i = 0; i < 10; i++) {
                    addRow(3, i + 1);
                }
            }
        }
        
        // ä¿®æ”¹ä¿å­˜æ•°æ®å‡½æ•°ï¼Œåœ¨ä¿å­˜æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨åè‡ªåŠ¨ç”Ÿæˆå…¶ä»–è¡¨æ ¼
        const originalSaveData = saveData;
        saveData = function() {
            originalSaveData();
            
            // é˜²æ­¢é¢‘ç¹è§¦å‘è‡ªåŠ¨ç”Ÿæˆ
            if (window.autoGenTimeout) clearTimeout(window.autoGenTimeout);
            
            // å¦‚æœå½“å‰åœ¨æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨é¡µé¢ï¼Œè‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡è¡¨æ ¼
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'tab0') {
                window.autoGenTimeout = setTimeout(() => {
                    autoGenerateStats();
                    window.autoGenTimeout = null;
                }, 1000);
            }
        };
        
        // æ·»åŠ ä¸€ä¸ªæ‰‹åŠ¨è§¦å‘è‡ªåŠ¨ç”Ÿæˆçš„æŒ‰é’®å‡½æ•°
        function triggerAutoGenerate() {
            autoGenerateStats();
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg) {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s;
            `;
            div.textContent = msg;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.animation = 'slideOut 0.3s';
                setTimeout(() => div.remove(), 300);
            }, 2000);
        }

        // ä¼˜åŒ–ç­›é€‰åŠŸèƒ½ï¼Œæ·»åŠ é˜²æŠ–
        let filterTimeout;
        function filterByClass() {
            if (filterTimeout) clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                const classValue = document.getElementById('classFilter').value;
                filterConditions.class = classValue;
                applyFilter();
                filterTimeout = null;
            }, 200);
        }

        function filterByStudent() {
            if (filterTimeout) clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                const studentValue = document.getElementById('studentFilter').value;
                filterConditions.student = studentValue;
                applyFilter();
                filterTimeout = null;
            }, 200);
        }

        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const tbody = document.getElementById('tbody3');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const classCell = row.cells[1]; // ç­çº§åˆ—
                const studentCell = row.cells[0]; // å­¦ç”Ÿå§“ååˆ—
                
                const classText = classCell ? classCell.textContent || classCell.innerText : '';
                const studentText = studentCell ? studentCell.textContent || studentCell.innerText : '';
                
                const classMatch = !filterConditions.class || classText.includes(filterConditions.class);
                const studentMatch = !filterConditions.student || studentText.includes(filterConditions.student);
                
                row.style.display = classMatch && studentMatch ? '' : 'none';
            });
        }

        // è‡ªåŠ¨ç»Ÿè®¡åŠŸèƒ½
        function calculateStats() {
            // ä»ç¬¬ä¸€ä¸ªè¡¨æ ¼ç»Ÿè®¡é”™è¯¯ç±»å‹
            const mainData = getTableData(0);
            const errorTypes = {};
            
            mainData.forEach(row => {
                const errorType = row[6]; // é”™è¯¯ç±»å‹åˆ—
                const count = parseInt(row[7]) || 0; // å‡ºé”™æ¬¡æ•°åˆ—
                if (errorType && errorType.trim()) {
                    errorTypes[errorType] = (errorTypes[errorType] || 0) + count;
                }
            });
            
            showMessage('ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        // ä¼˜åŒ–é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ä»¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦
            setTimeout(() => {
                for (let i = 0; i < 5; i++) {
                    initTable(i);
                }
                showMessage('æ¬¢è¿ä½¿ç”¨æ˜“é”™é¢˜ç»Ÿè®¡è¡¨ï¼');
            }, 100);
        };

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // ç±»ä¼¼é¢˜ç›®ç”ŸæˆåŠŸèƒ½
        // é¢˜ç›®ç”Ÿæˆè§„åˆ™åº“
        const questionTemplates = {
            '100ä»¥å†…åŠ å‡æ³•': {
                'è®¡ç®—é”™è¯¯': [
                    '{num1} + {num2} = ?',
                    '{num3} - {num4} = ?',
                    '{num1} + {num2} + {num5} = ?',
                    '{num3} - {num4} + {num1} = ?'
                ],
                'è¿›ä½é”™è¯¯': [
                    'è®¡ç®—ï¼š{num6} + {num7} = ? (æ³¨æ„è¿›ä½)',
                    'è®¡ç®—ï¼š{num8} + {num9} = ? (éœ€è¦è¿›ä½)',
                    'å¡«ç©ºï¼š{num6} + ___ = {result1}'
                ],
                'é€€ä½é”™è¯¯': [
                    'è®¡ç®—ï¼š{num10} - {num11} = ? (æ³¨æ„é€€ä½)',
                    'è®¡ç®—ï¼š{num12} - {num13} = ? (éœ€è¦é€€ä½)',
                    'å¡«ç©ºï¼š{num10} - ___ = {result2}'
                ]
            },
            'è¡¨å†…ä¹˜æ³•': {
                'è®¡ç®—é”™è¯¯': [
                    '{num1} Ã— {num2} = ?',
                    '{num3} Ã— {num4} = ?',
                    'å¡«ç©ºï¼š{num1} Ã— ___ = {result3}',
                    'é€‰æ‹©ï¼š{num2} Ã— {num3} = (A) {wrong1} (B) {result4} (C) {wrong2}'
                ],
                'è®°å¿†æ€§é”™è¯¯': [
                    'èƒŒè¯µå¹¶è®¡ç®—ï¼š{num5} Ã— {num6} = ?',
                    'å¿«é€Ÿå›ç­”ï¼š{num7} Ã— {num8} = ?',
                    'è¿çº¿é¢˜ï¼šå°†ç®—å¼ä¸æ­£ç¡®ç­”æ¡ˆè¿æ¥'
                ]
            },
            'è¡¨å†…é™¤æ³•': {
                'è®¡ç®—é”™è¯¯': [
                    '{num1} Ã· {num2} = ?',
                    '{num3} Ã· {num4} = ?',
                    'å¡«ç©ºï¼š___ Ã· {num2} = {result5}',
                    'åˆ¤æ–­é¢˜ï¼š{num1} Ã· {num2} = {result5} (å¯¹/é”™)'
                ],
                'æ¦‚å¿µæ··æ·†': [
                    'åº”ç”¨é¢˜ï¼šå°†{num1}ä¸ªè‹¹æœå¹³å‡åˆ†ç»™{num2}ä¸ªå°æœ‹å‹ï¼Œæ¯äººåˆ†åˆ°å‡ ä¸ªï¼Ÿ',
                    'æ¯”è¾ƒé¢˜ï¼š{num3} Ã· {num4} ___ {num5} Ã· {num6} (>, <, =)'
                ]
            },
            'è®¤è¯†å›¾å½¢': {
                'æ¦‚å¿µæ··æ·†': [
                    'è¯†åˆ«é¢˜ï¼šè¯·åœ¨å›¾ä¸­æ‰¾å‡ºæ‰€æœ‰çš„{shape1}',
                    'åˆ†ç±»é¢˜ï¼šå°†ä»¥ä¸‹å›¾å½¢æŒ‰{feature1}åˆ†ç±»',
                    'åˆ¤æ–­é¢˜ï¼š{shape2}æœ‰{num1}æ¡è¾¹ (å¯¹/é”™)'
                ],
                'å›¾å½¢è¯†åˆ«é”™è¯¯': [
                    'é€‰æ‹©é¢˜ï¼šä»¥ä¸‹å“ªä¸ªæ˜¯{shape3}ï¼Ÿ',
                    'ç”»å›¾é¢˜ï¼šè¯·ç”»å‡ºä¸€ä¸ª{shape4}',
                    'æ•°ä¸€æ•°ï¼šå›¾ä¸­æœ‰å‡ ä¸ª{shape5}ï¼Ÿ'
                ]
            }
        };
        
        // å¸¸ç”¨æ•°å­—å’Œå›¾å½¢åº“
        const numberPool = [5, 8, 9, 12, 15, 18, 21, 24, 27, 32, 36, 42, 48, 54, 63, 72, 81];
        const shapePool = ['æ­£æ–¹å½¢', 'é•¿æ–¹å½¢', 'ä¸‰è§’å½¢', 'åœ†å½¢', 'å¹³è¡Œå››è¾¹å½¢', 'æ¢¯å½¢'];
        
        // åŠ è½½é”™é¢˜ç­›é€‰é€‰é¡¹
        function loadErrorQuestions() {
            // è·å–ç­›é€‰æ¡ä»¶
            const topic = document.getElementById('errorTopicSelect').value;
            const errorType = document.getElementById('errorTypeSelect').value;
            
            // è·å–æ˜“é”™é¢˜æ•°æ®
            const errorData = getTableData(0); // æ˜“é”™é¢˜ç»Ÿè®¡æ€»è¡¨
            
            // ç­›é€‰ç›¸å…³é”™é¢˜
            const filteredQuestions = errorData.filter(row => {
                const rowTopic = row[3] || ''; // çŸ¥è¯†ç‚¹ç±»åˆ«
                const rowErrorType = row[5] || ''; // é”™è¯¯ç±»å‹
                return (!topic || rowTopic.includes(topic)) && 
                       (!errorType || rowErrorType.includes(errorType));
            });
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœ
            const listContainer = document.getElementById('errorQuestionsList');
            if (filteredQuestions.length === 0) {
                listContainer.innerHTML = '<p style="color: #666;">æœªæ‰¾åˆ°ç›¸å…³é”™é¢˜</p>';
                return;
            }
            
            let html = '<h4 style="margin-bottom: 10px;">ç›¸å…³é”™é¢˜ï¼š</h4><ul style="list-style-type: decimal; padding-left: 20px;">';
            filteredQuestions.forEach((row, index) => {
                const studentName = row[1] || '';
                const topic = row[3] || '';
                const questionDesc = row[4] || '';
                const errorType = row[5] || '';
                html += `<li style="margin-bottom: 8px;">
                    <strong>${studentName}</strong> - ${topic} - ${errorType}<br>
                    <span style="color: #555;">é¢˜ç›®æè¿°ï¼š${questionDesc}</span>
                </li>`;
            });
            html += '</ul>';
            listContainer.innerHTML = html;
        }
        
        // ç”Ÿæˆç±»ä¼¼é¢˜ç›®
        function generateSimilarQuestions() {
            // è·å–ç­›é€‰æ¡ä»¶
            const topic = document.getElementById('errorTopicSelect').value;
            const errorType = document.getElementById('errorTypeSelect').value;
            
            if (!topic || !errorType) {
                showMessage('è¯·å…ˆé€‰æ‹©çŸ¥è¯†ç‚¹å’Œé”™è¯¯ç±»å‹');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„é¢˜ç›®æ¨¡æ¿
            if (!questionTemplates[topic] || !questionTemplates[topic][errorType]) {
                showMessage('æš‚æ— è¯¥ç±»å‹é¢˜ç›®çš„ç”Ÿæˆæ¨¡æ¿');
                return;
            }
            
            // è·å–é¢˜ç›®æ¨¡æ¿
            const templates = questionTemplates[topic][errorType];
            const generatedList = document.getElementById('generatedQuestionsList');
            
            // ç”Ÿæˆ5é“ç±»ä¼¼é¢˜ç›®
            let html = '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">';
            html += '<h4 style="margin-bottom: 15px; color: #2c3e50;">ç”Ÿæˆçš„ç»ƒä¹ é¢˜ç›®ï¼š</h4>';
            html += '<ol style="padding-left: 20px;">';
            
            for (let i = 0; i < 5; i++) {
                // éšæœºé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
                const template = templates[Math.floor(Math.random() * templates.length)];
                
                // éšæœºé€‰æ‹©æ•°å­—å’Œå›¾å½¢
                const num1 = numberPool[Math.floor(Math.random() * numberPool.length)];
                const num2 = numberPool[Math.floor(Math.random() * numberPool.length)];
                const num3 = numberPool[Math.floor(Math.random() * numberPool.length)];
                const num4 = numberPool[Math.floor(Math.random() * numberPool.length)];
                const num5 = numberPool[Math.floor(Math.random() * numberPool.length)];
                const num6 = numberPool[Math.floor(Math.random() * numberPool.length)] + 5;
                const num7 = numberPool[Math.floor(Math.random() * numberPool.length)] + 6;
                const num8 = numberPool[Math.floor(Math.random() * numberPool.length)] + 7;
                const num9 = numberPool[Math.floor(Math.random() * numberPool.length)] + 8;
                const num10 = numberPool[Math.floor(Math.random() * numberPool.length)] + 20;
                const num11 = numberPool[Math.floor(Math.random() * numberPool.length)] + 10;
                const num12 = numberPool[Math.floor(Math.random() * numberPool.length)] + 30;
                const num13 = numberPool[Math.floor(Math.random() * numberPool.length)] + 15;
                
                const shape1 = shapePool[Math.floor(Math.random() * shapePool.length)];
                const shape2 = shapePool[Math.floor(Math.random() * shapePool.length)];
                const shape3 = shapePool[Math.floor(Math.random() * shapePool.length)];
                const shape4 = shapePool[Math.floor(Math.random() * shapePool.length)];
                const shape5 = shapePool[Math.floor(Math.random() * shapePool.length)];
                
                // è®¡ç®—ä¸€äº›ç»“æœ
                const result1 = num6 + Math.floor(Math.random() * 10);
                const result2 = num10 - Math.floor(Math.random() * 10);
                const result3 = num1 * num2;
                const result4 = num2 * num3;
                const result5 = num1 / num2;
                
                const wrong1 = result4 + Math.floor(Math.random() * 5) + 1;
                const wrong2 = Math.max(1, result4 - Math.floor(Math.random() * 5) - 1);
                
                // æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦
                let question = template
                    .replace(/{num1}/g, num1)
                    .replace(/{num2}/g, num2)
                    .replace(/{num3}/g, num3)
                    .replace(/{num4}/g, num4)
                    .replace(/{num5}/g, num5)
                    .replace(/{num6}/g, num6)
                    .replace(/{num7}/g, num7)
                    .replace(/{num8}/g, num8)
                    .replace(/{num9}/g, num9)
                    .replace(/{num10}/g, num10)
                    .replace(/{num11}/g, num11)
                    .replace(/{num12}/g, num12)
                    .replace(/{num13}/g, num13)
                    .replace(/{result1}/g, result1)
                    .replace(/{result2}/g, result2)
                    .replace(/{result3}/g, result3)
                    .replace(/{result4}/g, result4)
                    .replace(/{result5}/g, result5)
                    .replace(/{wrong1}/g, wrong1)
                    .replace(/{wrong2}/g, wrong2)
                    .replace(/{shape1}/g, shape1)
                    .replace(/{shape2}/g, shape2)
                    .replace(/{shape3}/g, shape3)
                    .replace(/{shape4}/g, shape4)
                    .replace(/{shape5}/g, shape5)
                    .replace(/{feature1}/g, 'è¾¹æ•°');
                
                html += `<li style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    ${question}
                </li>`;
            }
            
            html += '</ol>';
            html += '<div style="margin-top: 20px; text-align: center;">';
            html += '<button onclick="generateSimilarQuestions()" style="padding: 10px 20px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>';
            html += '</div></div>';
            
            generatedList.innerHTML = html;
            showMessage('ç±»ä¼¼é¢˜ç›®ç”ŸæˆæˆåŠŸï¼');
        }
        
        // æ¸…ç©ºç”Ÿæˆçš„é¢˜ç›®
        function clearGeneratedQuestions() {
            document.getElementById('generatedQuestionsList').innerHTML = '';
            document.getElementById('errorQuestionsList').innerHTML = '';
            showMessage('å·²æ¸…ç©ºç”Ÿæˆé¢˜ç›®');
        }
        
        // åˆå§‹åŒ–é¢˜ç›®ç”Ÿæˆå™¨é€‰é¡¹
        function initQuestionGenerator() {
            // å¡«å……çŸ¥è¯†ç‚¹é€‰é¡¹
            const topicSelect = document.getElementById('errorTopicSelect');
            dropdownOptions.knowledgePoints.forEach(point => {
                const option = document.createElement('option');
                option.value = point;
                option.textContent = point;
                topicSelect.appendChild(option);
            });
            
            // å¡«å……é”™è¯¯ç±»å‹é€‰é¡¹
            const errorTypeSelect = document.getElementById('errorTypeSelect');
            dropdownOptions.errorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                errorTypeSelect.appendChild(option);
            });
        }
        
        // ä¿®æ”¹é¡µé¢åŠ è½½å‡½æ•°ä»¥åŒ…å«æ–°åŠŸèƒ½çš„åˆå§‹åŒ–
        const originalOnload = window.onload;
        window.onload = function() {
            if (originalOnload) originalOnload();
            initQuestionGenerator();
        };
    </script>
</body>
</html>